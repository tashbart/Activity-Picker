<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sydney Activity Picker</title>
<meta name="description" content="Pick activities by tags like Indoors, Cultural, Nighttime, Scenic, etc.">
<style>
  :root{
    --bg:#0b0e14; --bgSoft:#0f1320; --card:rgba(18,20,31,.72);
    --ink:#e9ecf1; --inkSoft:#b9c0d0;
    --accent:#7bdcbe; --accent2:#9dd4ff;
    --chip:#151a29; --chipOn:#113426;
    --muted:#8f96ad; --border:rgba(120,136,160,.15);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --ring: 0 0 0 3px rgba(123,220,190,.25);
  }
  /* Light mode palette */
  :root.light{
    --bg:#f6f8fb; --bgSoft:#eef2f8; --card:#ffffffcc;
    --ink:#0f1726; --inkSoft:#47506a;
    --accent:#0fbf9f; --accent2:#3a82ff;
    --chip:#eef2f8; --chipOn:#dff6ef;
    --muted:#5f6b85; --border:rgba(20,30,50,.13);
    --shadow: 0 10px 30px rgba(14,23,38,.12);
    --ring: 0 0 0 3px rgba(15,191,159,.25);
  }

  html,body{height:100%;}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(123,220,190,.12), transparent 40%),
      radial-gradient(1000px 800px at 110% 10%, rgba(157,212,255,.10), transparent 40%),
      var(--bg);
    color:var(--ink);
  }
  .wrap{max-width:1100px; margin:auto; padding:24px;}
  h1{font-size:clamp(22px,3vw,32px); margin:0 0 6px; letter-spacing:.2px}
  .sub{color:var(--inkSoft); margin:0 0 18px}

  /* Header bar */
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2));
        box-shadow: var(--shadow); display:grid; place-items:center; font-weight:800; color:#0a0f10}
  .muted{color:var(--muted)}

  /* Panels + sticky controls */
  .panel{
    background:var(--card); backdrop-filter: blur(10px);
    border:1px solid var(--border); border-radius:16px; padding:14px; margin-bottom:16px;
    box-shadow: var(--shadow);
  }
  .panel.sticky{
    position:sticky; top:10px; z-index:5;
  }

  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

  .pill{
    display:flex; gap:10px; align-items:center; background:var(--bgSoft);
    border:1px solid var(--border); padding:8px 10px; border-radius:999px; color:var(--inkSoft)
  }
  .pill input{accent-color:var(--accent)}

  .search{flex:1; min-width:220px}
  .search input{
    width:100%; padding:11px 14px; border-radius:12px;
    border:1px solid var(--border); background:color-mix(in oklab, var(--bg) 88%, black 0%);
    color:var(--ink); outline:none; transition:border .15s, box-shadow .15s
  }
  .search input:focus{ box-shadow: var(--ring); border-color: color-mix(in oklab, var(--accent) 60%, black 0%) }

  .btn{
    background:linear-gradient(180deg, var(--accent), color-mix(in oklab, var(--accent) 80%, black 12%));
    color:#0a0f10; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    box-shadow: 0 6px 16px rgba(123,220,190,.3); transition: transform .08s ease, box-shadow .15s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(123,220,190,.38) }
  .btn:active{ transform: translateY(0) }
  .btn.secondary{
    background:transparent; color:var(--ink);
    border:1px solid var(--border); box-shadow:none; font-weight:600
  }
  .btn.ghost{
    background:transparent; border:1px dashed var(--border); color:var(--ink);
  }
  .btn.toggle{padding:8px 10px}

  /* Tag chips */
  .chip{
    position:relative; border:1px solid var(--border); background:var(--chip); color:var(--ink);
    padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none; font-size:13px;
    transition: background .12s, border-color .12s, transform .06s
  }
  .chip:hover{ transform: translateY(-1px) }
  .chip input{position:absolute; opacity:0; inset:0; width:100%; height:100%; cursor:pointer}
  .chip.active{background:var(--chipOn); border-color: color-mix(in oklab, var(--accent) 60%, black 0%)}

  /* Cards / results */
  .results{display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:14px; margin-top:12px}
  .card{
    background:var(--card); backdrop-filter: blur(8px);
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow: var(--shadow); transition: transform .12s ease, border-color .12s ease;
  }
  .card:hover{ transform: translateY(-2px); border-color: color-mix(in oklab, var(--accent2) 55%, black 0%) }
  .title{font-weight:800; margin:0 0 6px; font-size:16px; letter-spacing:.2px}
  .meta{color:var(--inkSoft); font-size:12px; margin-bottom:10px}
  .tags{display:flex; gap:6px; flex-wrap:wrap}
  .tag{font-size:11px; padding:4px 10px; border:1px solid var(--border); border-radius:999px; color:var(--inkSoft); background:color-mix(in oklab, var(--bgSoft) 90%, black 0%)}

  /* Empty state */
  .empty{display:grid; place-items:center; text-align:center; padding:36px; color:var(--muted)}
  .empty .bubble{
    display:inline-block; padding:10px 12px; border-radius:999px; background:var(--chip);
    border:1px solid var(--border); margin-top:8px; font-size:12px
  }

  /* Toast */
  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:linear-gradient(180deg,#133825,#0f2d20);
    border:1px solid #1c5641; color:#baf0db; padding:10px 14px; border-radius:12px; display:none; z-index:60;
    box-shadow: var(--shadow)
  }

  /* Drawer */
  .drawer{position:fixed; inset:0; display:none; align-items:stretch; z-index:50}
  .drawer.open{display:flex}
  .shade{flex:1; background:rgba(0,0,0,.5)}
  .panel2{width:min(520px, 92vw); background:#0e1118; border-left:1px solid var(--border); padding:18px; overflow:auto}
  .field{margin:10px 0}
  .label{font-size:12px; color:var(--muted); margin-bottom:6px}
  .input, .select, .textarea{width:100%; background:#0b0f15; border:1px solid var(--border); color:var(--ink);
                             border-radius:10px; padding:10px 12px}
  .textarea{min-height:84px; resize:vertical}
  .row2{display:flex; gap:8px; flex-wrap:wrap}
  .err{color:var(--danger); font-size:12px; display:none}

  /* Mobile */
  *{-webkit-tap-highlight-color:transparent}
  input,button{font-size:16px}
  @media (max-width:640px){
    .wrap{padding:16px}
    .toolbar{flex-direction:column; align-items:stretch; gap:10px}
    .search{width:100%; min-width:0}
    .btn{width:100%}
    .chip{padding:10px 12px; margin:2px 0}
    .results{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
    .panel.sticky{position:static}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">SY</div>
        <div>
          <h1>Sydney Activity Picker <span class="muted" style="font-size:12px">v3.2</span></h1>
          <div class="sub">Tick tags, choose category/indoor‚Äìoutdoor, search‚Ä¶ then <b>Surprise me</b> or pick from the list.</div>
        </div>
      </div>
      <button class="btn secondary toggle" id="themeToggle" aria-label="Toggle theme">üåô/‚òÄÔ∏è</button>
    </div>

    <!-- Controls -->
    <div class="panel sticky">
      <div class="row toolbar">
        <div class="pill" role="radiogroup" aria-label="Category">
          <label><input type="radio" name="cat" value="All" checked> All</label>
          <label><input type="radio" name="cat" value="Seasonal"> Seasonal</label>
          <label><input type="radio" name="cat" value="Permanent"> Permanent</label>
        </div>

        <div class="pill" aria-label="Indoor/Outdoor">
          <label><input type="checkbox" id="indoors"> Indoors</label>
          <label><input type="checkbox" id="outdoors"> Outdoors</label>
        </div>

        <div class="search"><input id="q" type="text" placeholder="Search name or tags‚Ä¶"></div>

        <button class="btn" id="randomBtn">üé≤ Surprise me</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
        <button class="btn ghost" id="openSuggest">Suggest an activity</button>
        <div class="counts" id="count"></div>
      </div>

      <div class="row" id="tagChips" style="margin-top:10px"></div>
      <div class="muted" style="margin-top:6px">Filters use <b>AND</b> logic. (e.g., Indoors + Cultural + Nighttime)</div>
    </div>

    <!-- Results -->
    <div class="results" id="results"></div>

    <div class="muted" style="margin-top:14px">
      State is saved in the URL so you can bookmark combos. (<a href="#" class="link" id="shareLink">copy current link</a>)
    </div>
  </div>

  <!-- Suggest Drawer -->
  <div class="drawer" id="drawer">
    <div class="shade" id="closeDrawer"></div>
    <div class="panel2">
      <div class="row2" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">Suggest an activity</h3>
        <button class="btn secondary" id="xClose">Close</button>
      </div>

      <div class="field">
        <div class="label">Activity *</div>
        <input class="input" id="f_activity" placeholder="e.g., Sunset picnic at Barangaroo">
        <div class="err" id="e_activity">Please enter an activity.</div>
      </div>

      <div class="field">
        <div class="label">Category *</div>
        <select class="select" id="f_category">
          <option value="">Select‚Ä¶</option>
          <option>Seasonal</option>
          <option>Permanent</option>
        </select>
        <div class="err" id="e_category">Please choose a category.</div>
      </div>

      <!-- CHECKLIST TAGS -->
      <div class="field">
        <div class="label">Tags *</div>
        <div id="f_tags_wrap" class="row2" style="gap:10px"></div>
        <div class="note">Pick as many as you like.</div>
        <div class="err" id="e_tags">Please choose at least one tag.</div>
      </div>

      <div class="row2" style="margin-top:12px">
        <button class="btn" id="submitSuggest">Submit</button>
        <button class="btn secondary" id="cancelSuggest">Cancel</button>
      </div>

      <div class="note" style="margin-top:10px">Submissions go to a Google Sheet for review. Only approved ideas appear on the site.</div>
    </div>
  </div>

  <div class="toast" id="toast">Thanks! Your idea was submitted for review.</div>

<script>
/* ================== CONFIG (edit these two lines) ================== */
// Apps Script Web App URL (from your deployment)
const SUBMIT_URL     = "https://script.google.com/macros/s/AKfycbwdyK8Q7-uHW3u121dQtmZtv1jLbU1Xl4pzQrksM7vUQIopWx71yL-qiCIif5LhIoU/exec";
// Published CSV link for your sheet (File ‚Üí Share ‚Üí Publish to web ‚Üí CSV)
const SHEET_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQglaw4_81WylM20K4VT2fFmBARr8CcSjBu23svzco-2z_alzRn1mj9oM_r56M6wecL0gnN9Bd8qXYn/pub?gid=0&single=true&output=csv";
/* ================================================================== */

/* Allowed tags for submissions (shown as checkboxes) */
const TAG_OPTIONS = [
  "Outdoors","Indoors","Active","Relaxing","Scenic","Cultural",
  "Creative","Food & Drink","Nightlife","Animals","Day trip","Water activity"
];

/* ---------- Helpers ---------- */
const row = (name, category, tags) => ({name, category, tags});
const norm = s => (s||"").toString().trim().toLowerCase();
const $ = sel => document.querySelector(sel);
const el = (t,c,txt)=>Object.assign(document.createElement(t),{className:c||"",textContent:txt||""});

/* ---------- Base data (optional seed; everything else comes from Sheet) ---------- */
const activities = [
  row("Bushwalking and picnic","Seasonal",["Outdoors","Active","Scenic"]),
];

/* Precompute normalized tag string for bullet-proof checks */
activities.forEach(a => { a._tagStr = ";" + a.tags.map(norm).join(";") + ";"; });

/* ---------- Chips (dynamic) ---------- */
let ALL_TAGS = [];
function toTitleCaseKey(k){ return k.replace(/\b\w/g, c=>c.toUpperCase()); }

function rebuildChipsFromActivities(preserve=true){
  const prev = preserve
    ? new Set([...document.querySelectorAll('#tagChips input[type="checkbox"]:checked')].map(i=>i.dataset.tag))
    : new Set();

  const keys = Array.from(new Set(activities.flatMap(a => a.tags.map(norm)))).sort();
  ALL_TAGS = keys.map(k => ({ key: k, label: toTitleCaseKey(k) }));

  const tagWrap = $("#tagChips");
  tagWrap.innerHTML = "";

  ALL_TAGS.forEach(({key,label})=>{
    const lab = el("label","chip");
    const inp = document.createElement("input");
    inp.type = "checkbox";
    inp.dataset.tag = key; inp.value = key; inp.setAttribute("aria-label", label);
    if (prev.has(key)) { inp.checked = true; lab.classList.add("active"); }
    inp.addEventListener("change", ()=>{ lab.classList.toggle("active", inp.checked); update(); });
    lab.append(inp, document.createTextNode(" " + label));
    tagWrap.append(lab);
  });
}

/* ---------- Load APPROVED rows from Sheet (CSV) ---------- */
async function loadApprovedFromSheet(){
  try{
    const resp = await fetch(SHEET_CSV_URL, { cache: "no-store" });
    if(!resp.ok) return;
    const text = await resp.text();
    const rows = parseCSV(text);
    const objs = rowsToObjects(rows);
    const approved = objs.filter(o => (o['Approved'] || '').toLowerCase() === 'true');

    const add = approved.map(o => ({
      name: o['Activity'],
      category: o['Category'],
      tags: (o['Tags'] || '').split(';').map(t => t.trim()).filter(Boolean)
    })).filter(x => x.name && (x.category==='Seasonal' || x.category==='Permanent'));

    add.forEach(a => a._tagStr = ";" + a.tags.map(norm).join(";") + ";";

    if (add.length){
      activities.push(...add);
      rebuildChipsFromActivities(true);
      update();
    }
  }catch(e){ console.warn('CSV load failed', e); }
}

// Tiny CSV parser (handles quotes)
function parseCSV(text){
  const rows=[]; let i=0, field="", row=[], inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c=='"' && text[i+1]=='"'){ field+='"'; i+=2; continue; }
      if(c=='"'){ inQ=false; i++; continue; }
      field+=c; i++; continue;
    }else{
      if(c=='"'){ inQ=true; i++; continue; }
      if(c==','){ row.push(field); field=""; i++; continue; }
      if(c=='\n'){ row.push(field); rows.push(row); field=""; row=[]; i++; continue; }
      field+=c; i++; continue;
    }
  }
  if(field.length||row.length){ row.push(field); rows.push(row); }
  return rows;
}
function rowsToObjects(rows){
  const [head,...body]=rows; if(!head) return [];
  return body.map(r=>{ const o={}; head.forEach((h,idx)=>o[(h||'').trim()]= (r[idx]||'').trim()); return o; });
}

/* ---------- Controls & matching ---------- */
function getState(){
  const cat = [...document.querySelectorAll('input[name="cat"]')].find(i=>i.checked).value;
  const indoors = $("#indoors").checked;
  const outdoors = $("#outdoors").checked;
  const q = $("#q").value.trim().toLowerCase();
  const tags = [...document.querySelectorAll('#tagChips input[type="checkbox"]')]
    .filter(i=>i.checked).map(i=>i.dataset.tag); // normalized keys
  return {cat, indoors, outdoors, q, tags};
}
function matches(a, st){
  if(st.cat!=="All" && a.category!==st.cat) return false;
  if(st.indoors && !a._tagStr.includes(";indoors;")) return false;
  if(st.outdoors && !a._tagStr.includes(";outdoors;")) return false;
  for(const t of st.tags){ if(!a._tagStr.includes(";"+t+";")) return false; }
  if(st.q){
    const hay=(a.name+" "+a.category+" "+a.tags.join(" ")).toLowerCase();
    if(!hay.includes(st.q)) return false;
  }
  return true;
}
function render(list){
  const box=$("#results"); box.innerHTML="";
  if(!list.length){
    const wrap = document.createElement("div");
    wrap.className = "empty";
    wrap.innerHTML = `
      <div>
        <div style="font-weight:700;font-size:15px;margin-bottom:6px">No matches</div>
        <div class="muted">Try removing a tag or two, or clearing Indoor/Outdoor.</div>
        <div class="bubble">Tip: chips use <b>AND</b> logic</div>
      </div>`;
    box.append(wrap);
    $("#count").textContent="0 matches";
    return;
  }
  for(const a of list){
    const card=el("div","card");
    card.append(el("div","title",a.name));
    card.append(el("div","meta",a.category));
    const tags=el("div","tags"); a.tags.forEach(t=>tags.append(el("span","tag",t)));
    card.append(tags); box.append(card);
  }
  $("#count").textContent=`${list.length} match${list.length===1?"":"es"}`;
}

/* ---------- URL state ---------- */
function writeHash(st){ const o={c:st.cat,i:st.indoors?1:0,o:st.outdoors?1:0,q:st.q,t:st.tags}; location.hash=encodeURIComponent(JSON.stringify(o)); }
function readHash(){ if(!location.hash) return null; try{return JSON.parse(decodeURIComponent(location.hash.slice(1)));}catch{return null;} }
function applyHash(o){
  if(!o) return;
  [...document.querySelectorAll('input[name="cat"]')].forEach(r=> r.checked=(r.value===o.c));
  $("#indoors").checked=!!o.i; $("#outdoors").checked=!!o.o; $("#q").value=o.q||"";
  const want=new Set((o.t||[]).map(norm));
  document.querySelectorAll('#tagChips input[type="checkbox"]').forEach(cb=>{
    cb.checked=want.has(cb.dataset.tag); cb.parentElement.classList.toggle("active",cb.checked);
  });
}

/* ---------- Build tag checklist for submit drawer ---------- */
function buildTagChecklist() {
  const wrap = document.getElementById("f_tags_wrap");
  wrap.innerHTML = "";
  TAG_OPTIONS.forEach(t => {
    const id = "tag_" + t.toLowerCase().replace(/\s+/g,'_');
    const lbl = document.createElement("label");
    lbl.className = "chip";
    lbl.style.cursor = "pointer";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.id = id;
    cb.value = t;
    cb.addEventListener("change", () => lbl.classList.toggle("active", cb.checked));
    lbl.append(cb, document.createTextNode(" " + t));
    wrap.append(lbl);
  });
}

/* ---------- Suggest form handlers ---------- */
const drawer = $("#drawer"), toast=$("#toast");
function openDrawer(){
  document.querySelectorAll("#f_tags_wrap input[type=checkbox]").forEach(cb=>{
    cb.checked = false; cb.parentElement.classList.remove("active");
  });
  drawer.classList.add("open");
}
function closeDrawer(){ drawer.classList.remove("open"); }
function showToast(msg){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 2600); }

async function submitSuggestion(){
  const a=$("#f_activity").value.trim();
  const c=$("#f_category").value.trim();
  const picked=[...document.querySelectorAll("#f_tags_wrap input[type=checkbox]:checked")].map(i=>i.value);

  // validation
  $("#e_activity").style.display = a ? 'none' : 'block';
  $("#e_category").style.display = c ? 'none' : 'block';
  $("#e_tags").style.display     = picked.length ? 'none' : 'block';
  if(!a || !c || !picked.length) return;

  // turn picked tags into semicolon string
  const t = picked.join("; ");

  // URL-encoded POST (no preflight)
  const body = new URLSearchParams({ activity:a, category:c, tags:t }).toString();
  try{
    await fetch(SUBMIT_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body
    });
    closeDrawer();
    // clear form
    $("#f_activity").value = ""; $("#f_category").value = "";
    document.querySelectorAll("#f_tags_wrap input[type=checkbox]").forEach(cb=>{
      cb.checked = false; cb.parentElement.classList.remove("active");
    });
    showToast("Thanks! Your idea was submitted for review.");
  }catch(e){
    showToast("Sorry, something went wrong. Try again?");
  }
}

/* ---------- Theme toggle ---------- */
const themeToggle = document.getElementById("themeToggle");
function applyTheme(t){ document.documentElement.classList.toggle('light', t==='light'); localStorage.setItem('theme', t); }
const saved = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light':'dark');
applyTheme(saved);
themeToggle.addEventListener('click', ()=>{
  const now = document.documentElement.classList.contains('light') ? 'dark' : 'light';
  applyTheme(now);
});

/* ---------- Update & events ---------- */
function update(){ const st=getState(); const list=activities.filter(a=>matches(a,st)); render(list); writeHash(st); }
$("#randomBtn").addEventListener("click",()=>{ const st=getState(); const list=activities.filter(a=>matches(a,st)); if(!list.length) return alert("No matches to choose from. Loosen filters?"); const pick=list[Math.floor(Math.random()*list.length)]; alert("üéâ "+pick.name); });
$("#clearBtn").addEventListener("click",()=>{ $("#q").value=""; $("#indoors").checked=false; $("#outdoors").checked=false; document.querySelector('input[name="cat"][value="All"]').checked=true; document.querySelectorAll('#tagChips input[type="checkbox"]').forEach(cb=>{ cb.checked=false; cb.parentElement.classList.remove("active"); }); update(); });
$("#openSuggest").addEventListener("click", openDrawer);
$("#closeDrawer").addEventListener("click", closeDrawer);
$("#xClose").addEventListener("click", closeDrawer);
$("#cancelSuggest").addEventListener("click", closeDrawer);
$("#submitSuggest").addEventListener("click", submitSuggestion);
$("#q").addEventListener("input", update);
$("#shareLink").addEventListener("click", e=>{ e.preventDefault(); navigator.clipboard.writeText(location.href).then(()=> alert("Link copied!")); });
document.querySelectorAll('input[name="cat"]').forEach(r=> r.addEventListener("change", update));
$("#indoors").addEventListener("change", update);
$("#outdoors").addEventListener("change", update);

/* ---------- Init ---------- */
rebuildChipsFromActivities(false);
applyHash(readHash());
update();
buildTagChecklist();
loadApprovedFromSheet();
</script>
</body>
</html>

