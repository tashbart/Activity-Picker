<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sydney Activity Picker</title>
<meta name="description" content="Pick activities by tags, price, planning, and time of day.">
<style>
  :root{
    --bg:#0b0c10; --card:#111218; --ink:#e6e7ee; --dim:#aeb1c6; --accent:#7bdcbe;
    --chip:#1b1e29; --chipOn:#133229; --muted:#7f86a1; --border:#242636; --danger:#e06b6b;
  }
  html,body{height:100%;}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink);}
  .wrap{max-width:1100px; margin:auto; padding:24px;}
  h1{font-size:clamp(22px,3vw,32px); margin:0 0 12px;}
  .panel{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .chip{position:relative; border:1px solid var(--border); background:var(--chip); color:var(--ink);
        padding:8px 10px; border-radius:999px; cursor:pointer; user-select:none; font-size:13px}
  .chip input{position:absolute; opacity:0; inset:0; width:100%; height:100%; cursor:pointer}
  .chip.active{background:var(--chipOn); border-color:#1e7c61}
  .search{flex:1; min-width:220px}
  .search input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0e1016; color:#e6e7ee}
  .btn{background:var(--accent); color:#0a0f10; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
  .btn.secondary{background:#1b2130; color:#e6e7ee; border:1px solid var(--border)}
  .results{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; margin-top:12px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px}
  .title{font-weight:700; margin:0 0 2px; font-size:15px}
  .meta{color:var(--muted); font-size:12px; margin-bottom:8px}
  .tags{display:flex; gap:6px; flex-wrap:wrap}
  .tag{font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--dim)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .pill{display:flex; gap:8px; align-items:center; background:#0d1117; border:1px solid var(--border); padding:8px 10px; border-radius:999px; color:var(--dim)}
  .muted{color:var(--muted)} .counts{margin-left:auto; color:var(--dim); font-size:13px}
  a.link{color:var(--accent); text-decoration:none}
  *{-webkit-tap-highlight-color:transparent}
  input,button{font-size:16px}
  .pill label{font-size:14px; font-weight:600;}
  .pill input{transform:scale(.95);}
  .cta-row{margin-top:12px; text-align:center;}
  .btn.cta{display:inline-block; background:#2b303b; color:#e6e7ee; border:1px solid var(--border);
           padding:10px 14px; border-radius:10px; font-weight:700; letter-spacing:.2px;}
  .btn.cta:hover{ background:#353b48; }
  .footnote{ font-size:12px; margin-top:14px; }
  @media (max-width:640px){
    .wrap{padding:16px}
    .toolbar{flex-direction:column; align-items:stretch; gap:10px}
    .search{width:100%; min-width:0}
    .btn{width:100%}
    .chip{padding:10px 12px; margin:2px 0}
    .results{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
  }
  .drawer{position:fixed; inset:0; display:none; align-items:stretch; z-index:50}
  .drawer.open{display:flex}
  .shade{flex:1; background:rgba(0,0,0,.5)}
  .panel2{width:min(520px, 92vw); background:#0e1118; border-left:1px solid var(--border); padding:18px; overflow:auto}
  .field{margin:10px 0}
  .label{font-size:12px; color:var(--muted); margin-bottom:6px}
  .input, .select{width:100%; background:#0b0f15; border:1px solid var(--border); color:var(--ink); border-radius:10px; padding:10px 12px}
  .note{font-size:12px; color:var(--muted); margin-top:6px}
  .row2{display:flex; gap:8px; flex-wrap:wrap}
  .err{color:var(--danger); font-size:12px; display:none}
  .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#14241c; border:1px solid #194d3d;
         color:#b6f0d8; padding:10px 14px; border-radius:10px; display:none; z-index:60}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Sydney Activity Picker</h1>

    <!-- Controls -->
    <div class="panel">
      <div class="row toolbar">
        <div class="pill" role="radiogroup" aria-label="Category">
          <label><input type="radio" name="cat" value="All" checked> All</label>
          <label><input type="radio" name="cat" value="Seasonal"> Seasonal</label>
          <label><input type="radio" name="cat" value="Permanent"> Permanent</label>
        </div>

        <div class="pill" aria-label="Indoor/Outdoor">
          <label><input type="checkbox" id="indoors"> Indoors</label>
          <label><input type="checkbox" id="outdoors"> Outdoors</label>
        </div>

        <div class="pill" aria-label="Price">
          <label><input type="checkbox" id="free"> Free</label>
          <label><input type="checkbox" id="dollar">$</label>
          <label><input type="checkbox" id="dollars">$$</label>
          <label><input type="checkbox" id="dollarss">$$$</label>
        </div>

        <div class="pill" aria-label="Plan">
          <label><input type="checkbox" id="spontaneous"> Spontaneous</label>
          <label><input type="checkbox" id="bookahead"> Book ahead</label>
        </div>

        <div class="pill" aria-label="Time of day">
          <label><input type="checkbox" id="daytime"> Daytime</label>
          <label><input type="checkbox" id="nighttime"> Nighttime</label>
          <label><input type="checkbox" id="anytime"> Anytime</label>
        </div>

        <div class="search"><input id="q" type="text" placeholder="Search name or tagsâ€¦"></div>

        <button class="btn" id="randomBtn">ðŸŽ² Surprise me</button>
        <button class="btn secondary" id="clearBtn">Clear</button>
        <div class="counts" id="count"></div>
      </div>

      <div class="row" id="tagChips" style="margin-top:10px"></div>

      <div class="cta-row">
        <button class="btn cta" id="openSuggest">ï¼‹ Suggest an activity</button>
      </div>
    </div>

    <!-- Results -->
    <div class="results" id="results"></div>

    <div class="muted footnote">
      State is saved in the URL so you can bookmark combos. (<a href="#" class="link" id="shareLink">copy current link</a>)
    </div>
  </div>

  <!-- Suggest Drawer -->
  <div class="drawer" id="drawer">
    <div class="shade" id="closeDrawer"></div>
    <div class="panel2">
      <div class="row2" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">Suggest an activity</h3>
        <button class="btn ghost" id="xClose">Close</button>
      </div>

      <div class="field">
        <div class="label">Activity *</div>
        <input class="input" id="f_activity" placeholder="e.g., Sunset picnic at Barangaroo">
        <div class="err" id="e_activity">Please enter an activity.</div>
      </div>

      <div class="field">
        <div class="label">Category *</div>
        <select class="select" id="f_category">
          <option value="">Selectâ€¦</option>
          <option>Seasonal</option>
          <option>Permanent</option>
        </select>
        <div class="err" id="e_category">Please choose a category.</div>
      </div>

      <!-- Tags checklist built by JS -->
      <div class="field">
        <div class="label">Tags *</div>
        <div id="f_tags_wrap" class="row2" style="gap:10px"></div>
        <div class="note">Pick as many as you like.</div>
        <div class="err" id="e_tags">Please choose at least one tag.</div>
      </div>

      <div class="row2" style="margin-top:12px">
        <button class="btn" id="submitSuggest">Submit</button>
        <button class="btn secondary" id="cancelSuggest">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Thanks! Your idea was submitted for review.</div>

<script>
const SUBMIT_URL     = "https://script.google.com/macros/s/AKfycbxRPq05wzFwqIfAwD7XDwA-k0rkAY-0uiC1vZ9b0f3DhNWx-lAiaydOYywOgBrEEFQ/exec";
const SHEET_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQglaw4_81WylM20K4VT2fFmBARr8CcSjBu23svzco-2z_alzRn1mj9oM_r56M6wecL0gnN9Bd8qXYn/pub?gid=0&single=true&output=csv";

const TAG_OPTIONS = [
 "Active","Animals","Class","Creative","Cultural","Day trip","Educational","Entertainment",
 "Food & Drink","Indoors","Nightlife","Outdoors","Relaxing","Scenic","Water activity"
];

const row = (name, category, tags, price, plan, time) => ({name, category, tags, price, plan, time});
const norm = s => (s||"").toString().trim().toLowerCase();
const $ = sel => document.querySelector(sel);
const el = (t,c,txt)=>Object.assign(document.createElement(t),{className:c||"",textContent:txt||""});

const activities = [];
activities.forEach(a => { a._tagStr = ";" + a.tags.map(norm).join(";") + ";"; });

let ALL_TAGS = [];
function toTitleCaseKey(k){ return k.replace(/\b\w/g, c=>c.toUpperCase()); }

function rebuildChipsFromActivities(preserve=true){
  const prev = preserve
    ? new Set([...document.querySelectorAll('#tagChips input[type="checkbox"]:checked')].map(i=>i.dataset.tag))
    : new Set();
  const keys = Array.from(new Set(activities.flatMap(a => a.tags.map(norm)))).sort();
  ALL_TAGS = keys.map(k => ({ key: k, label: toTitleCaseKey(k) }));
  const tagWrap = $("#tagChips"); tagWrap.innerHTML = "";
  ALL_TAGS.forEach(({key,label})=>{
    const lab = el("label","chip");
    const inp = document.createElement("input");
    inp.type="checkbox"; inp.dataset.tag=key; inp.value=key;
    if (prev.has(key)) { inp.checked=true; lab.classList.add("active"); }
    inp.addEventListener("change", ()=>{ lab.classList.toggle("active", inp.checked); update(); });
    lab.append(inp, document.createTextNode(" "+label));
    tagWrap.append(lab);
  });
}

async function loadApprovedFromSheet(){
  try{
    const resp = await fetch(SHEET_CSV_URL, { cache:"no-store" });
    if(!resp.ok) return;
    const text = await resp.text();
    const rows = parseCSV(text);
    const objs = rowsToObjects(rows);
    const approved = objs.filter(o => (o['Approved']||'').toLowerCase()==='true');
    const add = approved.map(o => ({
      name:o['Activity'],
      category:o['Category'],
      tags:(o['Tags']||'').split(';').map(t=>t.trim()).filter(Boolean),
      price:o['PriceBin']||'',
      plan:o['Plan']||'',
      time:o['TimeOfDay']||''
    })).filter(x=>x.name && (x.category==='Seasonal' || x.category==='Permanent'));
    add.forEach(a=>a._tagStr=";"+a.tags.map(norm).join(";")+";");
    if(add.length){ activities.push(...add); rebuildChipsFromActivities(true); update(); }
  }catch(e){ console.warn('CSV load failed', e); }
}

function parseCSV(text){
  const rows=[]; let i=0, field="", row=[], inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c=='"'&&text[i+1]=='"'){field+='"';i+=2;continue;}
      if(c=='"'){inQ=false;i++;continue;}
      field+=c;i++;continue;
    }else{
      if(c=='"'){inQ=true;i++;continue;}
      if(c==','){row.push(field);field="";i++;continue;}
      if(c=='\n'){row.push(field);rows.push(row);field="";row=[];i++;continue;}
      field+=c;i++;continue;
    }
  }
  if(field.length||row.length){row.push(field);rows.push(row);}
  return rows;
}
function rowsToObjects(rows){
  const [head,...body]=rows; if(!head) return [];
  return body.map(r=>{const o={}; head.forEach((h,idx)=>o[(h||'').trim()]=(r[idx]||'').trim()); return o;});
}

function getState(){
  const cat=[...document.querySelectorAll('input[name="cat"]')].find(i=>i.checked).value;
  const indoors=$("#indoors").checked; const outdoors=$("#outdoors").checked;
  const free=$("#free").checked; const dollar=$("#dollar").checked;
  const dollars=$("#dollars").checked; const dollarss=$("#dollarss").checked;
  const spont=$("#spontaneous").checked; const boka=$("#bookahead").checked;
  const day=$("#daytime").checked; const night=$("#nighttime").checked; const any=$("#anytime").checked;
  const q=$("#q").value.trim().toLowerCase();
  const tags=[...document.querySelectorAll('#tagChips input[type="checkbox"]')].filter(i=>i.checked).map(i=>i.dataset.tag);
  return {cat, indoors, outdoors, free,dollar,dollars,dollarss,spont,boka,day,night,any,q,tags};
}

function matches(a,st){
  if(st.cat!=="All" && a.category!==st.cat) return false;
  if(st.indoors && !a._tagStr.includes(";indoors;")) return false;
  if(st.outdoors && !a._tagStr.includes(";outdoors;")) return false;
  if(st.free && a.price!=="Free") return false;
  if(st.dollar && a.price!=="$") return false;
  if(st.dollars && a.price!=="$$") return false;
  if(st.dollarss && a.price!=="$$$") return false;
  if(st.spont && a.plan!=="Spontaneous") return false;
  if(st.boka && a.plan!=="Book ahead") return false;
  if(st.day && a.time!=="Daytime") return false;
  if(st.night && a.time!=="Nighttime") return false;
  if(st.any && a.time!=="Anytime") return false;
  for(const t of st.tags){ if(!a._tagStr.includes(";"+t+";")) return false; }
  if(st.q){ const hay=(a.name+" "+a.category+" "+a.tags.join(" ")).toLowerCase(); if(!hay.includes(st.q)) return false; }
  return true;
}

function render(list){
  const box=$("#results"); box.innerHTML="";
  if(!list.length){ box.append(el("div","muted","No matches. Try fewer filters.")); $("#count").textContent="0 matches"; return; }
  for(const a of list){
    const card=el("div","card");
    card.append(el("div","title
